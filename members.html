<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>PrivÃ© Cartel | Members Directory</title>
  <meta name="description" content="Live roster with avatars, search and sortable columns for all PrivÃ© Cartel members.">

  <!-- ICON & FONTS -->
  <link rel="icon" href="images/Emblem.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&family=Cormorant+Garamond:wght@500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- GLOBAL THEME -->
  <link rel="stylesheet" href="assets/style.css">

  <!-- PAGE STYLE -->
  <style>
  /* 1. FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar{display:flex;flex-wrap:wrap;gap:.75rem;margin:2rem 0 1.6rem}
  .filter-bar input{flex:1 1 230px;max-width:360px;padding:.7rem 1rem;
    border:2px solid var(--accent);border-radius:var(--radius);
    background:var(--bg-1);color:var(--text-1)}
  .filter-bar button{padding:.7rem 1.15rem;border:2px solid var(--accent);
    background:none;color:var(--accent);border-radius:var(--radius);
    cursor:pointer;transition:background .25s}
  .filter-bar button:hover{background:var(--accent);color:#000}

  /* 2. DESKTOP TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrap{overflow-x:auto}
  .member-table{width:100%;min-width:560px;border-collapse:collapse}
  .member-table th,.member-table td{padding:.65rem .8rem;
    border-bottom:1px solid rgba(var(--accent-rgb),.22);
    font-size:.93rem;text-align:left}
  .member-table th{color:var(--accent);cursor:pointer;user-select:none}
  .member-table tbody tr:nth-child(odd){background:rgba(255,255,255,.03)}
  .member-table tbody tr:hover{background:rgba(255,255,255,.05)}
  .member-table img.avatar{
    width:40px;height:40px;border-radius:50%;
    object-fit:cover;border:2px solid var(--accent);         /* gold ring */
  }

  /* status colours */
  .status-hospital,.status-jail{color:#ff6363;font-weight:600}
  .status-traveling            {color:#29cfff;font-weight:600}
  .status-abroad               {color:#ffd95a;font-weight:600}
  .status-okay                 {color:#4bd46f;font-weight:600}

  /* 3. MOBILE CARDS (â‰¤550 px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media(max-width:550px){
    .member-table{min-width:0}
    .member-table thead{display:none}
    .member-table,.member-table tbody{display:block}
    .member-table tr{
      display:grid;grid-template-columns:68px 1fr;
      gap:.45rem .9rem;padding:1rem .9rem;margin-bottom:1rem;
      background:rgba(255,255,255,.02);
      border:1px solid rgba(var(--accent-rgb),.24);
      border-radius:var(--radius)
    }
    .member-table td{border:none;padding:0;font-size:.9rem;line-height:1.5}
    .member-table td:nth-child(1){display:none}
    .member-table td[data-label="Avatar"]{
      order:-1;grid-row:span 6;display:flex;align-items:center}
    .member-table img.avatar{width:56px;height:56px}
    .member-table td[data-label]:not([data-label="Avatar"])::before{
      content:attr(data-label)': ';font-weight:600;color:var(--accent)}
  }

  .crown{color:var(--accent);margin-left:.25rem;font-size:.9rem}

  /* 4. NOTICE CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notice{
    background:rgba(var(--accent-rgb),.07);
    border-left:4px solid var(--accent);
    padding:1rem 1.25rem;margin-top:1.4rem;border-radius:var(--radius);
    color:var(--text-2);font-size:.88rem;line-height:1.6
  }
  .notice i{margin-right:.45rem;color:var(--accent)}
  .notice.loading::after{
    content:'';display:inline-block;width:15px;height:15px;margin-left:.7rem;
    border:3px solid var(--accent);border-top-color:transparent;border-radius:50%;
    animation:spin .8s linear infinite;vertical-align:-2px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .no-enc{color:#ff8d8d;font-weight:600}
  </style>
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
  <div class="logo"><span>PRIVÃ‰</span>&nbsp;CARTEL</div>
  <input type="checkbox" id="nav-toggle" class="nav-toggle" aria-label="Open navigation">
  <label for="nav-toggle" class="hamburger"><span></span><span></span><span></span></label>
  <nav>
    <ul class="nav-links">
      <li><a href="index.html"><i class="fa-solid fa-house"></i> Home</a></li>
      <li><a href="rules.html"><i class="fa-solid fa-scale-balanced"></i> Rules</a></li>
      <li><a href="guides.html"><i class="fa-solid fa-book"></i> Guides</a></li>
      <li><a href="members.html" class="active"><i class="fa-solid fa-users"></i> Members</a></li>
      <li><a href="news.html"><i class="fa-solid fa-bullhorn"></i> News</a></li>
      <li><a href="https://discord.gg/DmxrRAjBdk" target="_blank"><i class="fa-brands fa-discord"></i> Discord</a></li>
    </ul>
  </nav>
</header>
<div class="nav-overlay"></div>

<!-- HERO -->
<section class="rules-hero">
  <img src="images/Emblem.png" alt="Cartel Emblem">
  <h1>Faction&nbsp;Members</h1>
  <p class="tagline">Paste your Torn API key for real-time stats, or view the static roster snapshot.</p>
</section>

<!-- DIRECTORY -->
<section class="rules-block">
  <div class="container glass">

    <!-- FILTER BAR -->
    <div class="filter-bar">
      <input type="text"     id="memberSearch" placeholder="Search IGN, role, statusâ€¦">
      <input type="password" id="apiKeyInput"  placeholder="Paste API keyâ€¦">
      <button id="saveKeyBtn"><i class="fa-solid fa-key"></i> Save</button>
      <button id="clearKeyBtn" title="Clear key"><i class="fa-solid fa-trash"></i></button>
    </div>

    <!-- TABLE -->
    <div class="table-wrap">
      <table class="member-table" id="memberTable">
        <thead>
          <tr><th data-col="#">#</th><th data-col="ign">IGN</th><th></th>
              <th data-col="level">Lv</th><th data-col="role">Role</th>
              <th data-col="days">Days&nbsp;in</th><th data-col="status">Status</th></tr>
        </thead>
        <tbody id="memberBody"></tbody>
      </table>
    </div>

    <!-- PRIVACY NOTICE -->
    <div class="notice" id="notice">
      <i class="fa-solid fa-lock"></i>
      <strong>Privacy &amp; security:</strong> Your key is AES-GCM encrypted with a secret bound to this siteâ€™s origin
      and stored only in <code>localStorage</code>.  
      All API calls happen client-side over HTTPS.  
      Clear it any time with the&nbsp;<i class="fa-solid fa-trash"></i> icon.  
      <span class="no-enc" hidden>(Web Crypto unavailable â€” key stored in plain text on this device.)</span>
    </div>

  </div>
</section>

<!-- FOOTER -->
<footer><p>&copy; <span id="year"></span> PrivÃ© Cartel.</p></footer>

<!-- GLOBAL SCRIPT -->
<script src="assets/script.js"></script>

<!-- PAGE LOGIC -->
<script>
(()=>{                       /* scoped IIFE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LS='pcApiCipher', crownRX=/^(leader|co[- ]?leader|pbe founder)$/i, blank='images/blankprofile.jpg';
const $=s=>document.querySelector(s), body=$('#memberBody'), notice=$('#notice');
const apiInput=$('#apiKeyInput'), save=$('#saveKeyBtn'), clr=$('#clearKeyBtn'), search=$('#memberSearch');
let rows=[], cryptoOK=!!(crypto?.subtle);

/* â”€â”€â”€ Crypto helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function getKey(){
  const hash=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(location.origin));
  return crypto.subtle.importKey('raw',hash,{name:'AES-GCM'},false,['encrypt','decrypt']);
}
async function enc(txt){
  if(!cryptoOK)return txt;
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const cipher=await crypto.subtle.encrypt({name:'AES-GCM',iv},await getKey(),new TextEncoder().encode(txt));
  return[...iv,...new Uint8Array(cipher)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function dec(hex){
  if(!cryptoOK)return hex;
  const buf=new Uint8Array(hex.match(/../g).map(h=>parseInt(h,16)));
  const iv=buf.slice(0,12), data=buf.slice(12);
  try{
    const plain=await crypto.subtle.decrypt({name:'AES-GCM',iv},await getKey(),data);
    return new TextDecoder().decode(plain);
  }catch{return'';}
}

/* â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const crown=r=>crownRX.test(r)?' <i class="fa-solid fa-crown crown"></i>':'';
const tidy=s=>(s||'').replace(/_/g,' ');
const ico=s=>/hospital|jail/i.test(s)?'ðŸ¥':/travel/i.test(s)?'âœˆï¸':/abroad/i.test(s)?'ðŸŒ':'âœ…';
const cls=s=>/hospital|jail/i.test(s)?'status-hospital':/travel/i.test(s)?'status-traveling':/abroad/i.test(s)?'status-abroad':'status-okay';
const renum=()=>{let n=1;rows.forEach(r=>{if(r.style.display!=='none')r.children[0].textContent=n++;});};

/* â”€â”€â”€ Search filter (debounced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
search.addEventListener('input',(()=>{let t;return()=>{clearTimeout(t);t=setTimeout(()=>{const q=search.value.toLowerCase();rows.forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(q)?'':'none';});renum();},250);};})());

/* â”€â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const dir={};
document.querySelectorAll('.member-table th[data-col]').forEach(th=>{
  th.title='Sort';
  th.onclick=()=>{
    const c=th.dataset.col;dir[c]=!dir[c];
    rows.sort((a,b)=>{
      const A=a.dataset[c]||'',B=b.dataset[c]||'';
      return(/^(level|days)$/i.test(c)?(dir[c]?A-B:B-A):(dir[c]?A.localeCompare(B):B.localeCompare(A)));
    });
    rows.forEach(r=>body.appendChild(r));renum();
  };
});

/* â”€â”€â”€ Row renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function row(m){
  const raw=m.status?.state||m.status||'Okay', pretty=raw[0].toUpperCase()+raw.slice(1).toLowerCase(), role=tidy(m.position||m.role||'Member');
  const tr=document.createElement('tr');
  tr.dataset.level=m.level||0;tr.dataset.role=role.toLowerCase();tr.dataset.days=m.days_in_faction||m.days||0;tr.dataset.status=pretty.toLowerCase();
  tr.innerHTML=`<td>0</td>
    <td data-label="IGN">${m.id?`<a href="https://www.torn.com/profiles.php?XID=${m.id}" target="_blank">${m.name}</a>`:m.name}</td>
    <td data-label="Avatar"><img class="avatar" src="${blank}" data-id="${m.id||''}" alt=""></td>
    <td data-label="Lv">${m.level||0}</td>
    <td data-label="Role">${role}${crown(role)}</td>
    <td data-label="Days">${m.days_in_faction||m.days||0}</td>
    <td data-label="Status" class="${cls(pretty)}">${ico(pretty)} ${pretty}</td>`;
  body.appendChild(tr);
}

/* â”€â”€â”€ Snapshot fetch (external JSON) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function snapshot(){
  try{
    const res=await fetch('data/member-snapshot.json');
    if(!res.ok)throw new Error();const list=await res.json();
    body.innerHTML='';list.forEach(row);
  }catch{
    console.error('Snapshot JSON missing â€“ falling back to hard-code');
    body.innerHTML='<tr><td colspan="7">Snapshot unavailable.</td></tr>';
  }
  rows=[...body.querySelectorAll('tr')];renum();
}

/* â”€â”€â”€ Live fetch & lazy-avatars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function live(key){
  notice.classList.add('loading');
  try{
    const r=await fetch(`https://api.torn.com/faction/?selections=basic&key=${key}`);
    if(!r.ok)throw new Error('Torn API error');
    const d=await r.json();if(d.error)throw new Error(d.error.error);
    const list=Object.entries(d.members).map(([id,m])=>({...m,id}));
    body.innerHTML='';list.sort((a,b)=>b.level-a.level).forEach(row);
    rows=[...body.querySelectorAll('tr')];renum();search.dispatchEvent(new Event('input'));

    /* lazy-load avatars */
    const io=new IntersectionObserver(e=>{
      e.forEach(async v=>{
        if(!v.isIntersecting)return;
        const img=v.target;io.unobserve(img);
        try{
          const r=await fetch(`https://api.torn.com/user/${img.dataset.id}?selections=profile&key=${key}`);
          const j=await r.json();
          if(!j.error&&j.profile_image)img.src=j.profile_image;
        }catch{/* ignore */}
      });
    },{root:null,rootMargin:'200px'});
    body.querySelectorAll('img.avatar').forEach(i=>i.dataset.id&&io.observe(i));
  }catch(err){
    alert(err.message);snapshot();
  }
  notice.classList.remove('loading');
}

/* â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
save.onclick=async()=>{
  const k=apiInput.value.trim();
  if(k.length<10)return alert('Invalid API key');
  localStorage.setItem(LS,await enc(k));live(k);
};
clr.onclick=()=>{localStorage.removeItem(LS);location.reload();};

/* â”€â”€â”€ Initial boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async()=>{
  if(localStorage.getItem(LS)){
    const key=await dec(localStorage.getItem(LS));
    if(key){apiInput.value='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';live(key);}
    else snapshot();
  }else snapshot();
  if(!cryptoOK)notice.querySelector('.no-enc').hidden=false;
  $('#year').textContent=new Date().getFullYear();
})();
})();   /* IIFE END */
</script>
</body>
</html>
